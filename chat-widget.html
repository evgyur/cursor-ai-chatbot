<!-- AI Chat Widget - вставить перед </body> -->
<!-- Настройки -->
<script>
  window.aiChatConfig = {
    // Имя консультанта
    consultantName: "Консультант",
    // Приветствие
    welcomeMessage: "Здравствуйте! Я консультант. Могу рассказать об услугах, ценах и помочь с выбором. О чем хотите спросить?",
    // URL backend (изменить на свой сервер)
    apiUrl: "/api/chat",
    // Цвета
    primaryColor: "#6366f1",
    // Заголовок чата
    chatTitle: "Консультация"
  };
</script>

<style>
#ai-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 999999;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

#ai-chat-toggle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--primary-color, #6366f1);
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

#ai-chat-toggle:hover {
  transform: scale(1.05);
}

#ai-chat-toggle svg {
  width: 28px;
  height: 28px;
  fill: white;
}

#ai-chat-window {
  position: absolute;
  bottom: 80px;
  right: 0;
  width: 380px;
  height: 500px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
}

#ai-chat-window.open {
  display: flex;
}

.ai-chat-header {
  background: var(--primary-color, #6366f1);
  color: white;
  padding: 16px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.ai-chat-close {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 20px;
}

.ai-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.ai-message {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
}

.ai-message.user {
  background: var(--primary-color, #6366f1);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.ai-message.assistant {
  background: #f1f5f9;
  color: #1e293b;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.ai-message.error {
  background: #fee2e2;
  color: #dc2626;
  font-size: 12px;
}

.ai-chat-input {
  padding: 16px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 8px;
}

.ai-chat-input input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #e2e8f0;
  border-radius: 24px;
  outline: none;
  font-size: 14px;
}

.ai-chat-input input:focus {
  border-color: var(--primary-color, #6366f1);
}

.ai-chat-input button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--primary-color, #6366f1);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ai-chat-input button:disabled {
  background: #94a3b8;
  cursor: not-allowed;
}

.ai-chat-input button svg {
  width: 20px;
  height: 20px;
  fill: white;
}

.ai-api-key-input {
  padding: 12px 16px;
  background: #fef3c7;
  border-bottom: 1px solid #fcd34d;
}

.ai-api-key-input input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #d97706;
  border-radius: 8px;
  font-size: 12px;
  margin-bottom: 8px;
}

.ai-api-key-input button {
  width: 100%;
  padding: 8px;
  background: #d97706;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
}

.ai-typing {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
  background: #f1f5f9;
  border-radius: 16px;
  border-bottom-left-radius: 4px;
  width: fit-content;
}

.ai-typing span {
  width: 8px;
  height: 8px;
  background: #94a3b8;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.ai-typing span:nth-child(2) { animation-delay: 0.2s; }
.ai-typing span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-8px); }
}

@media (max-width: 480px) {
  #ai-chat-window {
    width: calc(100vw - 40px);
    right: -10px;
  }
}
</style>

<div id="ai-chat-widget">
  <div id="ai-chat-window">
    <div class="ai-chat-header">
      <span id="chat-title">Консультация</span>
      <button class="ai-chat-close" onclick="closeChat()">×</button>
    </div>
    
    <div id="api-key-section" class="ai-api-key-input" style="display: none;">
      <input type="password" id="api-key" placeholder="Введите MiniMax API Key">
      <input type="text" id="group-id" placeholder="Group ID">
      <button onclick="saveApiKey()">Сохранить и продолжить</button>
    </div>
    
    <div class="ai-chat-messages" id="chat-messages"></div>
    
    <div class="ai-chat-input">
      <input type="text" id="user-message" placeholder="Введите сообщение..." onkeypress="handleKeyPress(event)">
      <button id="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
  
  <button id="ai-chat-toggle" onclick="toggleChat()">
    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
  </button>
</div>

<script>
(function() {
  const config = window.aiChatConfig || {};
  const STORAGE_KEY = 'aiChat_apiKey';
  const GROUP_KEY = 'aiChat_groupId';
  
  let apiKey = localStorage.getItem(STORAGE_KEY);
  let groupId = localStorage.getItem(GROUP_KEY);
  
  // Установить заголовок
  if (config.chatTitle) {
    document.getElementById('chat-title').textContent = config.chatTitle;
  }
  
  // Показать окно
  window.toggleChat = function() {
    const win = document.getElementById('ai-chat-window');
    win.classList.toggle('open');
    
    if (win.classList.contains('open') && !apiKey) {
      document.getElementById('api-key-section').style.display = 'block';
    }
    
    if (win.classList.contains('open') && apiKey && document.getElementById('chat-messages').children.length === 0) {
      addMessage(config.welcomeMessage || 'Здравствуйте! Чем могу помочь?', 'assistant');
    }
  };
  
  window.closeChat = function() {
    document.getElementById('ai-chat-window').classList.remove('open');
  };
  
  window.saveApiKey = function() {
    const keyInput = document.getElementById('api-key');
    const groupInput = document.getElementById('group-id');
    
    if (keyInput.value && groupInput.value) {
      apiKey = keyInput.value;
      groupId = groupInput.value;
      localStorage.setItem(STORAGE_KEY, apiKey);
      localStorage.setItem(GROUP_KEY, groupId);
      document.getElementById('api-key-section').style.display = 'none';
      addMessage(config.welcomeMessage || 'Здравствуйте! Чем могу помочь?', 'assistant');
    }
  };
  
  window.handleKeyPress = function(e) {
    if (e.key === 'Enter') sendMessage();
  };
  
  window.sendMessage = async function() {
    const input = document.getElementById('user-message');
    const message = input.value.trim();
    const sendBtn = document.getElementById('send-btn');
    
    if (!message || !apiKey) return;
    
    addMessage(message, 'user');
    input.value = '';
    sendBtn.disabled = true;
    
    // Показать typing индикатор
    const typingId = addTyping();
    
    try {
      const response = await fetch(config.apiUrl || '/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: message,
          apiKey: apiKey,
          groupId: groupId
        })
      });
      
      removeTyping(typingId);
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || 'Ошибка запроса');
      }
      
      const data = await response.json();
      addMessage(data.response, 'assistant');
      
    } catch (err) {
      removeTyping(typingId);
      addMessage('Извините, произошла ошибка: ' + err.message, 'error');
    }
    
    sendBtn.disabled = false;
  };
  
  function addMessage(text, role) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `ai-message ${role}`;
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }
  
  function addTyping() {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = 'ai-typing';
    div.innerHTML = '<span></span><span></span><span></span>';
    div.id = 'typing-' + Date.now();
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div.id;
  }
  
  function removeTyping(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }
})();
</script>
